<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>üéÑ Magical Christmas Coin of Fate - Festive Fortune Teller | Interactive Coin Flip</title>
    <meta name="title" content="üéÑ Magical Christmas Coin of Fate - Festive Fortune Teller | Interactive Coin Flip">
    <meta name="description" content="üéÖ Dare to flip the magical Christmas coin? Experience a cozy holiday fortune-telling adventure with enchanted animations, festive sounds, and joyful predictions. Perfect for Christmas decisions!">
    <meta name="keywords" content="coin flip, magical coin toss, fortune teller, decision maker, coin game, magical fortune, digital coin, fortune teller, interactive game, decision tool">
    <meta name="author" content="Magical Coin of Fate">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="language" content="English">
    <meta name="revisit-after" content="3 days">

    <!-- Canonical URL - Fixed Netlify duplicate content -->
    <link rel="canonical" href="https://coinoffate.live/">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://coinoffate.live/">
    <meta property="og:title" content="üéÑ Magical Christmas Coin of Fate - Festive Fortune Teller">
    <meta property="og:description" content="üéÖ Dare to flip the magical Christmas coin? Experience a cozy holiday fortune-telling adventure with enchanted animations, festive sounds, and joyful predictions!">
    <meta property="og:image" content="https://coinoffate.live/icon-512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:image:alt" content="Magical Coin - Digital Fortune Teller">
    <meta property="og:site_name" content="Magical Coin of Fate">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://coinoffate.live/">
    <meta name="twitter:title" content="‚≠ê Magical Coin of Fate - Digital Fortune Teller">
    <meta name="twitter:description" content="‚ú® Dare to flip the magical coin? Enchanted animations, mystical sounds, and powerful predictions await!">
    <meta name="twitter:image" content="https://coinoffate.live/icon-512.png">
    <meta name="twitter:image:alt" content="Magical Coin Fortune Teller">

    <!-- Theme Color - Christmas Red & Gold -->
    <meta name="theme-color" content="#8B0000">
    <meta name="msapplication-TileColor" content="#D4AF37">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Humans.txt -->
    <link rel="author" href="/humans.txt">

    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Magical Coin of Fate - Digital Fortune Teller",
      "alternateName": "Interactive Coin Flip",
      "url": "https://coinoffate.live/",
      "description": "Dare to flip the magical coin? Experience stunning fortune-telling with our enchanted digital coin flip tool. Beautiful animations, mystical sounds, and powerful predictions for all your decisions.",
      "applicationCategory": "EntertainmentApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Magical Coin of Fate",
        "url": "https://coinoffate.live/"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.9",
        "ratingCount": "256",
        "reviewCount": "89"
      },
      "keywords": "coin flip, magical coin toss, fortune teller, decision maker, coin game, magical fortune, digital coin, interactive game"
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Magical Coin of Fate",
      "url": "https://coinoffate.live/",
      "logo": "https://coinoffate.live/icon-512.png",
      "sameAs": [
        "https://coinoffate.live/"
      ],
      "description": "Interactive fortune-telling and decision-making tool with stunning animations and mystical predictions"
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Magical Coin of Fate",
      "url": "https://coinoffate.live/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://coinoffate.live/?s={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is the Magical Coin of Fate?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The Magical Coin of Fate is an interactive digital coin flip tool that helps you make decisions with stunning visual effects. It features beautiful animations, mystical sound effects, and enchanting fortune-telling quotes."
          }
        },
        {
          "@type": "Question",
          "name": "Is this a real fortune teller?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "This is a fun entertainment tool using advanced probability algorithms. The coin flips are generated using Markov chain probability for entertainment purposes only, with a beautiful visual experience."
          }
        }
      ]
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Modern Premium Color Palette */
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --secondary-light: #f472b6;
            --accent: #f59e0b;
            --accent-light: #fbbf24;

            /* Neutrals */
            --bg-dark: #0f0f1e;
            --bg-darker: #07070d;
            --bg-light: #1a1a2e;
            --surface: rgba(255, 255, 255, 0.05);
            --surface-hover: rgba(255, 255, 255, 0.1);

            /* Text */
            --text-primary: #ffffff;
            --text-secondary: #a3a3c2;
            --text-muted: #6b6b8a;

            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(ellipse at top, #1a1a3e 0%, var(--bg-dark) 50%, var(--bg-darker) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15), transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.15), transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.1), transparent 70%);
            animation: gradientShift 20s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Subtle grid pattern */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes magicalFloat {
            0% { transform: translateX(0px) translateY(0px) rotate(0deg); }
            25% { transform: translateX(-25px) translateY(-15px) rotate(-3deg); }
            50% { transform: translateX(0px) translateY(-30px) rotate(0deg); }
            75% { transform: translateX(25px) translateY(-15px) rotate(3deg); }
            100% { transform: translateX(0px) translateY(0px) rotate(0deg); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes modernGlow {
            0%, 100% {
                box-shadow:
                    0 0 40px rgba(99, 102, 241, 0.4),
                    0 0 80px rgba(236, 72, 153, 0.3),
                    0 10px 60px rgba(0, 0, 0, 0.5);
            }
            50% {
                box-shadow:
                    0 0 60px rgba(99, 102, 241, 0.6),
                    0 0 100px rgba(236, 72, 153, 0.4),
                    0 15px 80px rgba(0, 0, 0, 0.6);
            }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.96); }
        }

        @keyframes starFloat {
            0% { transform: translateX(0) translateY(0) rotate(0deg); }
            25% { transform: translateX(-20px) translateY(10px) rotate(-8deg); }
            50% { transform: translateX(-35px) translateY(-5px) rotate(4deg); }
            75% { transform: translateX(-20px) translateY(12px) rotate(-4deg); }
            100% { transform: translateX(0) translateY(0) rotate(0deg); }
        }

        @keyframes particleFloat {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-15px) rotate(2deg); opacity: 1; }
            100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { transform: translateX(0%) scaleY(1); }
            50% { transform: translateX(-8%) scaleY(1.05); }
            100% { transform: translateX(0%) scaleY(1); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }

        .magical-flow {
            animation: magicalFloat 18s ease-in-out infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: modernGlow 3s infinite;
        }

        .twinkle {
            animation: twinkle 4s infinite;
        }

        /* Glassmorphic Coin Container */
        .coin-container {
            background: linear-gradient(135deg,
                rgba(99, 102, 241, 0.1) 0%,
                rgba(236, 72, 153, 0.1) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 0 60px rgba(99, 102, 241, 0.1),
                0 0 80px rgba(99, 102, 241, 0.2);
            position: relative;
            overflow: hidden;
        }

        .coin-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg,
                var(--primary) 0%,
                var(--secondary) 50%,
                var(--accent) 100%);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .coin-container:hover::before {
            opacity: 0.5;
        }

        /* Modern Gradient Text */
        .bg-gradient-text {
            background: linear-gradient(135deg,
                var(--primary-light) 0%,
                var(--secondary-light) 50%,
                var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient-shift 6s ease infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .star {
            animation: starFloat 5s ease-in-out infinite;
        }

        .particle {
            animation: particleFloat 6s ease-in-out infinite;
        }

        .shimmer {
            animation: shimmer 12s ease-in-out infinite;
        }

        /* Modern glow effect */
        .modern-glow {
            filter:
                drop-shadow(0 0 10px rgba(99, 102, 241, 0.5))
                drop-shadow(0 0 20px rgba(236, 72, 153, 0.3));
        }

        /* Magical text shadow */
        .magical-text {
            text-shadow:
                0 0 20px rgba(99, 102, 241, 0.6),
                0 0 40px rgba(236, 72, 153, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.5);
        }

        /* Glassmorphic card effect */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: var(--surface-hover);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(99, 102, 241, 0.2);
        }

        /* Modern button styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 14px 32px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow:
                0 10px 40px rgba(99, 102, 241, 0.4),
                0 0 20px rgba(236, 72, 153, 0.3);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-weight: 500;
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        /* Hover micro-interactions */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-3px);
        }

        /* Pulse ring animation */
        .pulse-ring {
            animation: pulse-ring 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading" class="min-h-screen relative overflow-hidden">
            <div class="absolute inset-0">
                <div id="particle-layer" class="shimmer"></div>
                <div id="floating-particles"></div>
            </div>
            <div class="relative z-10 flex items-center justify-center min-h-screen">
                <div class="text-center px-4 max-w-2xl mx-auto">
                    <div class="text-7xl mb-8 modern-glow animate-pulse">‚ú®</div>
                    <h1 class="text-5xl md:text-6xl mb-6 font-bold bg-gradient-text" style="letter-spacing: -0.02em;">
                        Coin of Fate
                    </h1>
                    <p class="text-xl mb-3 text-secondary-light font-medium">
                        "When destiny calls for a decision..."
                    </p>
                    <p class="text-sm mb-12" style="color: var(--text-secondary);">
                        Let the universe guide your choice
                    </p>
                    <div class="mt-8">
                        <button onclick="startApp()" class="btn-primary text-lg px-12 py-4 relative z-10">
                            <span class="relative z-10">Enter the Magic</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="min-h-screen relative overflow-hidden" style="display: none;">
            <!-- Floating particles background -->
            <div class="absolute inset-0" id="floating-elements"></div>

            <!-- Header -->
            <div class="relative text-center py-20 px-4 mb-12">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-center gap-6 mb-8">
                        <div class="w-12 h-12 flex items-center justify-center text-4xl modern-glow star">‚ú®</div>
                        <div class="text-center">
                            <h1 class="text-5xl md:text-7xl font-bold bg-gradient-text mb-3" style="letter-spacing: -0.02em;">
                                COIN OF FATE
                            </h1>
                            <p class="text-lg md:text-xl font-medium" style="color: var(--text-secondary);">
                                Let destiny make the call
                            </p>
                        </div>
                        <div class="w-12 h-12 flex items-center justify-center text-4xl modern-glow star" style="animation-delay: 2s;">üîÆ</div>
                    </div>

                    <div id="premium-badge" class="inline-flex items-center gap-2 px-5 py-2.5 glass-card" style="display: none;">
                        <span>‚ö°</span>
                        <span class="text-sm font-semibold bg-gradient-text">PREMIUM</span>
                    </div>
                </div>
            </div>

            <!-- Quote Section -->
            <div id="quote-section" class="relative py-12 px-6 mb-12">
                <div class="max-w-3xl mx-auto text-center glass-card p-8">
                    <div class="text-4xl mb-4 modern-glow">‚ú®</div>
                    <p id="current-quote" class="text-2xl md:text-3xl font-medium leading-relaxed mb-4" style="color: var(--text-primary);">
                        "The universe whispers your fortune..."
                    </p>
                    <p id="quote-translation" class="text-base" style="color: var(--text-secondary);">
                        What destiny awaits?
                    </p>
                </div>
            </div>

            <!-- Cauldron of Choices (Custom Inputs) -->
            <div class="relative py-8 px-6" style="border-bottom: 1px solid rgba(212, 175, 55, 0.15);">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-6">
                        <button onclick="toggleCustomMode()" class="px-6 py-3 border-2 transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: rgba(212, 175, 55, 0.5); color: #D4AF37; background: rgba(139, 69, 19, 0.1);">
                            <span class="text-2xl mr-2">üß™</span>
                            <span id="custom-toggle-text">CAULDRON OF CHOICES</span>
                            <span class="text-2xl ml-2">üß™</span>
                        </button>
                    </div>

                    <div id="custom-inputs-container" class="hidden">
                        <div class="text-center mb-6">
                            <p class="text-sm font-light italic" style="color: #FFD700;">
                                Brew your own destiny! Enter custom choices or keep the Christmas magic...
                            </p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                            <!-- Option 1 -->
                            <div class="glass-card p-6">
                                <label class="block text-sm font-light mb-2 tracking-wider" style="color: #D4AF37;">OPTION 1 (HEADS)</label>
                                <input type="text" id="custom-option1-text" placeholder="e.g., Pizza, Attack Dragon" maxlength="20" class="w-full px-4 py-2 mb-3 border rounded font-light" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(212, 175, 55, 0.3); color: #FFD700;" />
                                <label class="block text-sm font-light mb-2 tracking-wider" style="color: #D4AF37;">EMOJI (OPTIONAL)</label>
                                <input type="text" id="custom-option1-emoji" placeholder="üçï" maxlength="2" class="w-full px-4 py-2 border rounded text-center text-3xl" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(212, 175, 55, 0.3);" />
                            </div>

                            <!-- Option 2 -->
                            <div class="glass-card p-6">
                                <label class="block text-sm font-light mb-2 tracking-wider" style="color: #D4AF37;">OPTION 2 (TAILS)</label>
                                <input type="text" id="custom-option2-text" placeholder="e.g., Tacos, Run Away" maxlength="20" class="w-full px-4 py-2 mb-3 border rounded font-light" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(139, 0, 0, 0.4); color: #FF6B6B;" />
                                <label class="block text-sm font-light mb-2 tracking-wider" style="color: #D4AF37;">EMOJI (OPTIONAL)</label>
                                <input type="text" id="custom-option2-emoji" placeholder="üåÆ" maxlength="2" class="w-full px-4 py-2 border rounded text-center text-3xl" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(139, 0, 0, 0.4);" />
                            </div>
                        </div>

                        <div class="text-center mt-6 space-x-4">
                            <button onclick="saveCustomOptions()" class="px-8 py-3 border-2 transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: #D4AF37; color: #FFD700; background: rgba(212, 175, 55, 0.2);">
                                ‚ú® APPLY CHOICES ‚ú®
                            </button>
                            <button onclick="resetToDefault()" class="px-8 py-3 border transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: rgba(139, 69, 19, 0.5); color: #D4AF37;">
                                üéÑ RESET TO CHRISTMAS üéÑ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Doom Barometer -->
            <div class="relative py-8 px-6" style="border-bottom: 1px solid rgba(212, 175, 55, 0.15);">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2 twinkle">üìâ</div>
                        <h2 class="text-2xl font-light tracking-wider mb-2 magical-text" style="font-family: Georgia, serif; color: #FFD700;">
                            GLOBAL DOOM BAROMETER
                        </h2>
                        <p class="text-sm font-light italic" style="color: #D4AF37;">
                            The world's collective fate in real-time...
                        </p>
                    </div>

                    <div class="glass-card p-8">
                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="flex justify-between mb-2 text-sm font-light">
                                <span style="color: #FFD700;">üéÖ HEADS</span>
                                <span id="global-total-flips" style="color: #D4AF37;">Loading...</span>
                                <span style="color: #FF6B6B;">TAILS ü¶å</span>
                            </div>
                            <div class="w-full h-8 rounded-full overflow-hidden border-2" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(212, 175, 55, 0.3);">
                                <div class="h-full flex">
                                    <div id="global-heads-bar" class="transition-all duration-1000" style="width: 50%; background: linear-gradient(to right, #D4AF37, #FFD700);"></div>
                                    <div id="global-tails-bar" class="transition-all duration-1000" style="width: 50%; background: linear-gradient(to right, #FF6B6B, #8B0000);"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-6 text-center">
                            <div>
                                <div class="text-5xl font-bold mb-2 magical-text" style="color: #FFD700;" id="global-heads-count">0</div>
                                <div class="text-xs tracking-wider font-light" style="color: #D4AF37;">GLOBAL HEADS</div>
                                <div class="text-xs mt-1 font-light italic" style="color: rgba(212, 175, 55, 0.6);" id="global-heads-percent">50%</div>
                            </div>
                            <div>
                                <div class="text-5xl font-bold mb-2 magical-text" style="color: #FF6B6B;" id="global-tails-count">0</div>
                                <div class="text-xs tracking-wider font-light" style="color: #D4AF37;">GLOBAL TAILS</div>
                                <div class="text-xs mt-1 font-light italic" style="color: rgba(212, 175, 55, 0.6);" id="global-tails-percent">50%</div>
                            </div>
                        </div>

                        <!-- World Event -->
                        <div id="world-event" class="hidden mt-6 glass-card p-6 text-center border-2 animate-pulse" style="border-color: var(--accent);">
                            <div class="text-3xl mb-2">üéâ</div>
                            <p class="font-light" style="color: #FFD700;">WORLD EVENT UNLOCKED!</p>
                            <p class="text-xs mt-1" style="color: #D4AF37;" id="world-event-text"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S√©ance Mode (Multiplayer) -->
            <div class="relative py-8 px-6" style="border-bottom: 1px solid rgba(212, 175, 55, 0.15);">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2 twinkle">üîÆ</div>
                        <h2 class="text-2xl font-light tracking-wider mb-2 magical-text" style="font-family: Georgia, serif; color: #FFD700;">
                            S√âANCE MODE
                        </h2>
                        <p class="text-sm font-light italic" style="color: #D4AF37;">
                            Summon friends and share a synchronized fate...
                        </p>
                    </div>

                    <div id="seance-lobby" class="border rounded-lg p-8 patriotic-glow" style="border-color: rgba(212, 175, 55, 0.3); background: rgba(139, 69, 19, 0.1);">
                        <div class="text-center space-y-4">
                            <button onclick="createRoom()" class="w-full px-8 py-4 border-2 transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: #D4AF37; color: #FFD700; background: rgba(212, 175, 55, 0.2);">
                                <span class="text-2xl mr-2">üïØÔ∏è</span>
                                CREATE S√âANCE ROOM
                                <span class="text-2xl ml-2">üïØÔ∏è</span>
                            </button>

                            <div class="text-sm font-light" style="color: rgba(212, 175, 55, 0.6);">‚Äî OR ‚Äî</div>

                            <div class="flex gap-2">
                                <input type="text" id="room-code-input" placeholder="Enter room code..." maxlength="6" class="flex-1 px-4 py-3 border rounded font-light text-center tracking-widest" style="background: rgba(26, 15, 10, 0.8); border-color: rgba(212, 175, 55, 0.3); color: #FFD700;" />
                                <button onclick="joinRoom()" class="px-8 py-3 border transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: rgba(139, 69, 19, 0.5); color: #D4AF37;">
                                    JOIN
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="seance-room" class="hidden border rounded-lg p-8 patriotic-glow" style="border-color: rgba(212, 175, 55, 0.3); background: rgba(139, 69, 19, 0.1);">
                        <div class="text-center mb-6">
                            <div class="text-sm font-light mb-2" style="color: #D4AF37;">ROOM CODE</div>
                            <div class="text-4xl font-bold tracking-widest mb-4 magical-text" style="font-family: 'Courier New', monospace; color: #FFD700;" id="room-code-display"></div>
                            <button onclick="copyRoomCode()" class="text-xs px-4 py-2 border rounded transition-all hover-lift" style="border-color: rgba(212, 175, 55, 0.3); color: #D4AF37;">
                                üìã COPY LINK
                            </button>
                        </div>

                        <div class="border-t pt-6 mb-6" style="border-color: rgba(212, 175, 55, 0.2);">
                            <div class="text-sm font-light mb-3 text-center" style="color: #D4AF37;">PARTICIPANTS</div>
                            <div id="participants-list" class="space-y-2"></div>
                        </div>

                        <div id="host-controls" class="hidden text-center">
                            <p class="text-xs mb-3 font-light italic" style="color: #FFD700;">You are the host. Flip the coin to sync with all participants!</p>
                        </div>

                        <div class="text-center">
                            <button onclick="leaveRoom()" class="px-6 py-2 border transition-all duration-300 font-light tracking-wider hover-lift" style="border-color: rgba(139, 0, 0, 0.4); color: #FF6B6B;">
                                LEAVE S√âANCE
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Coin Section -->
            <div class="relative max-w-2xl mx-auto px-6 py-16">
                <!-- Coin -->
                <div class="flex justify-center mb-16">
                    <div class="relative">
                        <div id="coin" class="w-72 h-72 md:w-80 md:h-80 rounded-full flex items-center justify-center transform transition-all duration-2500 hover:scale-105 coin-container animate-pulse hover-lift">
                            <div id="coin-content" class="text-center relative z-10">
                                <div class="text-9xl mb-4 modern-glow">‚ö°</div>
                                <div class="text-lg font-semibold" style="color: var(--text-primary);">READY</div>
                            </div>
                        </div>

                        <!-- Modern glow rings -->
                        <div class="absolute inset-0 rounded-full border-2 scale-110 pulse-ring" style="border-color: rgba(99, 102, 241, 0.4);"></div>
                        <div class="absolute inset-0 rounded-full border-2 scale-125 pulse-ring" style="border-color: rgba(236, 72, 153, 0.3); animation-delay: 0.7s;"></div>
                        <div class="absolute inset-0 rounded-full border scale-140 pulse-ring" style="border-color: rgba(245, 158, 11, 0.2); animation-delay: 1.4s;"></div>

                        <!-- Floating particles around coin -->
                        <div class="absolute -left-12 top-1/4 text-4xl modern-glow particle" style="animation-delay: 0.5s;">‚ú®</div>
                        <div class="absolute -right-12 top-1/3 text-4xl modern-glow particle" style="animation-delay: 1.5s;">üí´</div>
                        <div class="absolute -left-8 bottom-1/4 text-3xl modern-glow star" style="animation-delay: 2.5s;">‚≠ê</div>
                        <div class="absolute -right-8 bottom-1/3 text-3xl modern-glow star" style="animation-delay: 3.5s;">üåü</div>
                    </div>
                </div>

                <!-- Flip Button -->
                <div class="text-center mb-16">
                    <button id="flip-btn" onclick="flipCoin()" class="btn-primary text-xl px-20 py-6 text-lg font-bold tracking-wide">
                        <span class="relative z-10">FLIP THE COIN</span>
                    </button>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-4 md:gap-6 mb-12">
                    <div class="glass-card text-center p-6 hover-lift">
                        <div class="text-3xl mb-3 modern-glow">üìä</div>
                        <div id="total-count" class="text-4xl font-bold mb-2 bg-gradient-text">0</div>
                        <div class="text-xs font-semibold tracking-wider" style="color: var(--text-secondary);">TOTAL FLIPS</div>
                    </div>
                    <div class="glass-card text-center p-6 hover-lift">
                        <div class="text-3xl mb-3 modern-glow">üåü</div>
                        <div id="heads-count" class="text-4xl font-bold mb-2" style="color: var(--primary-light);">0</div>
                        <div class="text-xs font-semibold tracking-wider" style="color: var(--text-secondary);">HEADS</div>
                    </div>
                    <div class="glass-card text-center p-6 hover-lift">
                        <div class="text-3xl mb-3 modern-glow">üí´</div>
                        <div id="tails-count" class="text-4xl font-bold mb-2" style="color: var(--secondary-light);">0</div>
                        <div class="text-xs font-semibold tracking-wider" style="color: var(--text-secondary);">TAILS</div>
                    </div>
                </div>

                <!-- History -->
                <div id="history-section" class="mb-12" style="display: none;">
                    <h3 class="text-center text-lg font-semibold mb-6" style="color: var(--text-primary);">
                        Recent Flips
                    </h3>
                    <div class="flex justify-center">
                        <div id="history-display" class="flex gap-3"></div>
                    </div>
                </div>

                <!-- Free Limit Warning -->
                <div id="limit-warning" class="mb-8 glass-card p-6 text-center border-2" style="display: none; border-color: var(--accent);">
                    <div class="text-4xl mb-3">‚ö†Ô∏è</div>
                    <p class="text-base font-medium mb-2" style="color: var(--text-primary);">
                        <span id="remaining-flips">2</span> flips remaining
                    </p>
                    <p class="text-sm" style="color: var(--text-secondary);">
                        Upgrade to Premium for unlimited flips!
                    </p>
                </div>

                <!-- Reset Button -->
                <div class="text-center">
                    <button onclick="resetApp()" class="btn-secondary px-10 py-3">
                        Reset
                    </button>
                </div>
            </div>

            <!-- Subscription Modal -->
            <div id="subscription-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50" style="display: none; background: rgba(7, 7, 13, 0.95); backdrop-filter: blur(10px);">
                <div class="glass-card p-10 max-w-md w-full text-center relative border-2" style="border-color: var(--primary);">
                    <div class="relative z-10">
                        <div class="mb-8">
                            <div class="text-6xl mx-auto mb-6 modern-glow animate-pulse">‚ö°</div>
                            <h2 class="text-3xl font-bold mb-4 bg-gradient-text">
                                Unlock Unlimited Power
                            </h2>
                            <p class="leading-relaxed" style="color: var(--text-secondary);">
                                Unlimited flips, exclusive features, and more...
                            </p>
                        </div>

                        <div class="glass-card p-6 mb-8 border-2" style="border-color: var(--primary);">
                            <div class="text-5xl font-bold mb-4 bg-gradient-text">$2.99</div>
                            <div class="text-sm mb-6" style="color: var(--text-secondary);">per month</div>
                            <div class="space-y-4 text-sm font-medium" style="color: var(--text-primary);">
                                <div class="flex items-center justify-center gap-3">
                                    <span class="modern-glow">‚ôæÔ∏è</span>
                                    <span>Unlimited flips</span>
                                </div>
                                <div class="flex items-center justify-center gap-3">
                                    <span class="modern-glow">‚ö°</span>
                                    <span>Premium badge</span>
                                </div>
                                <div class="flex items-center justify-center gap-3">
                                    <span class="modern-glow">üéµ</span>
                                    <span>Exclusive sound effects</span>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <button onclick="buyPremium()" class="btn-primary w-full py-4 text-lg">
                                <span class="relative z-10">Upgrade Now</span>
                            </button>
                            <button onclick="closeModal()" class="btn-secondary w-full py-3">
                                Maybe Later
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="relative py-12 text-center mt-20">
                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="flex justify-center gap-6 text-3xl mb-6">
                        <span class="modern-glow star">‚ú®</span>
                        <span class="modern-glow particle" style="animation-delay: 0.5s;">üí´</span>
                        <span class="modern-glow star" style="animation-delay: 1s;">‚≠ê</span>
                        <span class="modern-glow particle" style="animation-delay: 1.5s;">üåü</span>
                        <span class="modern-glow star" style="animation-delay: 2s;">‚ö°</span>
                    </div>
                    <p class="text-sm font-medium" style="color: var(--text-secondary);">
                        Powered by Markov Chain Probability
                    </p>
                    <p class="text-base italic font-medium bg-gradient-text">
                        "Let the universe decide your destiny"
                    </p>
                    <p class="text-xs mt-6" style="color: var(--text-muted);">
                        Made with magic & code
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        // TODO: Replace with your Firebase project configuration
        // Get your config from: https://console.firebase.google.com
        const firebaseConfig = {
            apiKey: "AIzaSyDEMO-REPLACE-WITH-YOUR-KEY",
            authDomain: "coinoffate-demo.firebaseapp.com",
            databaseURL: "https://coinoffate-demo-default-rtdb.firebaseio.com",
            projectId: "coinoffate-demo",
            storageBucket: "coinoffate-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.warn('Firebase not configured. Multiplayer and global stats disabled.', error);
        }

        // Global variables
        let tosses = 0;
        let history = [];
        let isPremium = false;
        let markovState = 'H';
        let isFlipping = false;

        // Multiplayer variables
        let currentRoom = null;
        let isHost = false;

        // Custom options
        let customOptions = {
            enabled: false,
            option1: { text: 'Heads', emoji: 'üåü' },
            option2: { text: 'Tails', emoji: 'üí´' }
        };

        const markovMatrix = {
            'H': { 'H': 0.45, 'T': 0.55 },
            'T': { 'H': 0.55, 'T': 0.45 }
        };

        // Magical quotes
        const magicalQuotes = [
            "The universe has spoken... destiny reveals itself|Your fate is written in the stars",
            "Embrace the cosmic wonder... miracles await|The universe reveals hidden truths",
            "The power of fate grows strong|What destiny brings beckons you",
            "Ancient magic guides your path|The cosmos calls to you",
            "In starlight and cosmic glow, truth is revealed|Your fortune awaits in wonder",
            "The magical coin knows your fate|Mystical powers at work",
            "Stardust dances in the moonlight|Your destiny is written in cosmic energy",
            "The universe has chosen|Divine energies surround you",
            "Embrace what fate brings|Fortune favors brave souls",
            "The cosmos whispers your name|Your path is illuminated by starlight",
            "Destiny awaits your choice|The universe decides your fortune",
            "Eternal magic guides the coin|Cosmic forces align"
        ];

        // Sound effects (using Web Audio API for festive sounds)
        let audioContext;
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playMagicalChime() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.5);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function playJingleSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1500, audioContext.currentTime + 0.3);

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Floating particles effect (falling snowflakes and Christmas elements)
        function createFloatingParticles() {
            const container = document.getElementById('floating-particles');
            const particleChars = ['‚ùÑÔ∏è', '‚õÑ', 'üéÑ', 'üéÅ', '‚≠ê', 'üîî'];
            const columns = Math.floor(window.innerWidth / 50);

            for (let i = 0; i < columns; i++) {
                const drop = document.createElement('div');
                drop.style.position = 'absolute';
                drop.style.left = i * 50 + 'px';
                drop.style.top = Math.random() * -1000 + 'px';
                drop.style.fontSize = '20px';
                drop.style.opacity = '0.4';
                drop.style.animation = `fall ${5 + Math.random() * 8}s linear infinite`;
                drop.style.animationDelay = Math.random() * 5 + 's';

                drop.textContent = particleChars[Math.floor(Math.random() * particleChars.length)];
                container.appendChild(drop);
            }
        }

        // Create floating Christmas elements
        function createFloatingElements() {
            const container = document.getElementById('floating-elements');
            const elements = ['üéÑ', '‚ùÑÔ∏è', '‚õÑ', 'üéÅ', 'üîî', 'üéÖ', 'ü¶å', '‚≠ê'];

            for (let i = 0; i < 25; i++) {
                const element = document.createElement('div');
                element.className = 'absolute opacity-20 text-2xl';
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';

                // Alternate between star and particle animations
                if (i % 2 === 0) {
                    element.className += ' star';
                } else {
                    element.className += ' particle';
                }

                element.style.animationDelay = Math.random() * 5 + 's';
                element.style.animationDuration = (4 + Math.random() * 4) + 's';
                element.textContent = elements[Math.floor(Math.random() * elements.length)];
                container.appendChild(element);
            }
        }

        // Create festive particle burst effect
        function createParticleBurst(x, y) {
            const particles = ['‚ùÑÔ∏è', '‚õÑ', 'üéÑ', 'üéÅ', '‚≠ê', 'üîî'];
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'absolute text-2xl';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.pointerEvents = 'none';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];

                const angle = (i / 12) * Math.PI * 2;
                const velocity = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 1000,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                });

                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Start app
        function startApp() {
            playJingleSound();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            createFloatingElements();
            updateQuote();
            loadCustomOptionsFromStorage();
            initGlobalStats();
        }

        // Global Stats Functions
        function initGlobalStats() {
            if (!db) {
                document.getElementById('global-total-flips').textContent = 'Firebase not configured';
                return;
            }

            // Listen for global stats changes
            db.ref('globalStats').on('value', (snapshot) => {
                const stats = snapshot.val() || { heads: 0, tails: 0 };
                updateGlobalDisplay(stats);
            });
        }

        function updateGlobalDisplay(stats) {
            const total = stats.heads + stats.tails;
            const headsPercent = total > 0 ? Math.round((stats.heads / total) * 100) : 50;
            const tailsPercent = total > 0 ? Math.round((stats.tails / total) * 100) : 50;

            document.getElementById('global-total-flips').textContent = `${total.toLocaleString()} Total Flips`;
            document.getElementById('global-heads-count').textContent = stats.heads.toLocaleString();
            document.getElementById('global-tails-count').textContent = stats.tails.toLocaleString();
            document.getElementById('global-heads-percent').textContent = `${headsPercent}%`;
            document.getElementById('global-tails-percent').textContent = `${tailsPercent}%`;

            // Update progress bars
            document.getElementById('global-heads-bar').style.width = `${headsPercent}%`;
            document.getElementById('global-tails-bar').style.width = `${tailsPercent}%`;

            // Check for world events
            checkWorldEvents(stats, total);
        }

        function checkWorldEvents(stats, total) {
            const worldEvent = document.getElementById('world-event');
            const eventText = document.getElementById('world-event-text');

            // Event triggers
            if (total >= 1000 && total % 1000 === 0) {
                worldEvent.classList.remove('hidden');
                eventText.textContent = `üéâ ${(total / 1000).toFixed(0)}K flips milestone reached! The magic grows stronger...`;
                setTimeout(() => worldEvent.classList.add('hidden'), 10000);
            } else if (stats.heads > 0 && stats.tails > 0) {
                const ratio = stats.heads / stats.tails;
                if (ratio > 2) {
                    worldEvent.classList.remove('hidden');
                    eventText.textContent = 'üéÖ Heads dominates! Santa\'s influence is overwhelming...';
                } else if (ratio < 0.5) {
                    worldEvent.classList.remove('hidden');
                    eventText.textContent = 'ü¶å Tails prevails! The reindeer have taken control...';
                } else {
                    worldEvent.classList.add('hidden');
                }
            }
        }

        function recordGlobalFlip(result) {
            if (!db) return;

            const field = result === 'H' ? 'heads' : 'tails';
            db.ref(`globalStats/${field}`).transaction((current) => {
                return (current || 0) + 1;
            });
        }

        // Multiplayer Functions
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluding similar-looking characters
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createRoom() {
            if (!db) {
                alert('Firebase not configured. Please set up Firebase to use multiplayer features.');
                return;
            }

            const roomCode = generateRoomCode();
            const userId = 'user_' + Math.random().toString(36).substr(2, 9);

            currentRoom = roomCode;
            isHost = true;

            // Create room in Firebase
            db.ref(`rooms/${roomCode}`).set({
                host: userId,
                createdAt: Date.now(),
                participants: {
                    [userId]: {
                        name: 'Host',
                        joinedAt: Date.now()
                    }
                },
                lastFlip: null
            });

            // Listen for room updates
            listenToRoom(roomCode, userId);

            // Update UI
            document.getElementById('seance-lobby').classList.add('hidden');
            document.getElementById('seance-room').classList.remove('hidden');
            document.getElementById('room-code-display').textContent = roomCode;
            document.getElementById('host-controls').classList.remove('hidden');

            playMagicalChime();
        }

        function joinRoom() {
            if (!db) {
                alert('Firebase not configured. Please set up Firebase to use multiplayer features.');
                return;
            }

            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                alert('Please enter a valid 6-character room code');
                return;
            }

            const userId = 'user_' + Math.random().toString(36).substr(2, 9);

            // Check if room exists
            db.ref(`rooms/${roomCode}`).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Room not found. Please check the code and try again.');
                    return;
                }

                currentRoom = roomCode;
                isHost = false;

                // Add user to room
                db.ref(`rooms/${roomCode}/participants/${userId}`).set({
                    name: 'Guest ' + Math.floor(Math.random() * 100),
                    joinedAt: Date.now()
                });

                // Listen for room updates
                listenToRoom(roomCode, userId);

                // Update UI
                document.getElementById('seance-lobby').classList.add('hidden');
                document.getElementById('seance-room').classList.remove('hidden');
                document.getElementById('room-code-display').textContent = roomCode;

                playMagicalChime();
            });
        }

        function listenToRoom(roomCode, userId) {
            // Listen for participant changes
            db.ref(`rooms/${roomCode}/participants`).on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                updateParticipantsList(participants);
            });

            // Listen for flip results
            db.ref(`rooms/${roomCode}/lastFlip`).on('value', (snapshot) => {
                const flip = snapshot.val();
                if (flip && !isHost && flip.timestamp > Date.now() - 5000) {
                    // Sync flip for non-host users
                    syncFlipResult(flip.result);
                }
            });
        }

        function updateParticipantsList(participants) {
            const list = document.getElementById('participants-list');
            list.innerHTML = '';

            Object.values(participants).forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-center gap-2 p-2 border rounded';
                div.style.borderColor = 'rgba(212, 175, 55, 0.2)';
                div.style.background = 'rgba(139, 69, 19, 0.1)';
                div.innerHTML = `
                    <span class="text-xl">üë§</span>
                    <span class="text-sm font-light" style="color: #FFD700;">${participant.name}</span>
                `;
                list.appendChild(div);
            });
        }

        function syncFlipResult(result) {
            // Force the coin to show the synchronized result
            const coin = document.getElementById('coin');
            const coinContent = document.getElementById('coin-content');

            coin.classList.add('animate-spin');
            playJingleSound();

            setTimeout(() => {
                coin.classList.remove('animate-spin');
                const isHeads = result === 'H';

                const displayEmoji = isHeads
                    ? (customOptions.enabled ? customOptions.option1.emoji : 'üéÖ')
                    : (customOptions.enabled ? customOptions.option2.emoji : 'ü¶å');

                const displayText = isHeads
                    ? (customOptions.enabled ? customOptions.option1.text.toUpperCase() + '!' : 'HEADS!')
                    : (customOptions.enabled ? customOptions.option2.text.toUpperCase() + '!' : 'TAILS!');

                coinContent.innerHTML = `
                    <div class="text-9xl mb-3 modern-glow">${displayEmoji}</div>
                    <div class="text-2xl tracking-wider font-bold magical-text" style="color: ${isHeads ? '#FFD700' : '#FF6B6B'};">${displayText}</div>
                `;

                playMagicalChime();
            }, 2000);
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('room-code-display').textContent;
            const url = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;

            navigator.clipboard.writeText(url).then(() => {
                alert('Room link copied to clipboard!');
            }).catch(() => {
                alert(`Share this room code: ${roomCode}`);
            });
        }

        function leaveRoom() {
            if (currentRoom && db) {
                // Remove participant from room
                db.ref(`rooms/${currentRoom}`).off();
                currentRoom = null;
                isHost = false;
            }

            // Update UI
            document.getElementById('seance-lobby').classList.remove('hidden');
            document.getElementById('seance-room').classList.add('hidden');
            document.getElementById('host-controls').classList.add('hidden');
            document.getElementById('room-code-input').value = '';

            playJingleSound();
        }

        // Check for room code in URL on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('room-code-input').value = roomCode;
            }
        });

        // Custom options functions
        function toggleCustomMode() {
            const container = document.getElementById('custom-inputs-container');
            const toggleText = document.getElementById('custom-toggle-text');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                toggleText.textContent = 'CLOSE CAULDRON';
                playJingleSound();
            } else {
                container.classList.add('hidden');
                toggleText.textContent = 'CAULDRON OF CHOICES';
            }
        }

        function saveCustomOptions() {
            const option1Text = document.getElementById('custom-option1-text').value.trim();
            const option1Emoji = document.getElementById('custom-option1-emoji').value.trim();
            const option2Text = document.getElementById('custom-option2-text').value.trim();
            const option2Emoji = document.getElementById('custom-option2-emoji').value.trim();

            if (!option1Text || !option2Text) {
                alert('Please enter both options!');
                return;
            }

            customOptions = {
                enabled: true,
                option1: {
                    text: option1Text,
                    emoji: option1Emoji || 'üéÖ'
                },
                option2: {
                    text: option2Text,
                    emoji: option2Emoji || 'ü¶å'
                }
            };

            // Save to localStorage
            localStorage.setItem('customOptions', JSON.stringify(customOptions));

            playMagicalChime();
            toggleCustomMode();
            resetApp();

            // Update coin display
            document.getElementById('coin-content').innerHTML = `
                <div class="text-9xl mb-4 modern-glow">${customOptions.option1.emoji}</div>
                <div class="text-lg tracking-wider font-light magical-text" style="color: #FFD700;">READY FOR MAGIC</div>
            `;
        }

        function resetToDefault() {
            customOptions = {
                enabled: false,
                option1: { text: 'Heads', emoji: 'üåü' },
                option2: { text: 'Tails', emoji: 'üí´' }
            };

            // Clear from localStorage
            localStorage.removeItem('customOptions');

            // Clear inputs
            document.getElementById('custom-option1-text').value = '';
            document.getElementById('custom-option1-emoji').value = '';
            document.getElementById('custom-option2-text').value = '';
            document.getElementById('custom-option2-emoji').value = '';

            playJingleSound();
            toggleCustomMode();
            resetApp();
        }

        function loadCustomOptionsFromStorage() {
            const saved = localStorage.getItem('customOptions');
            if (saved) {
                customOptions = JSON.parse(saved);

                if (customOptions.enabled) {
                    // Populate the inputs
                    document.getElementById('custom-option1-text').value = customOptions.option1.text;
                    document.getElementById('custom-option1-emoji').value = customOptions.option1.emoji;
                    document.getElementById('custom-option2-text').value = customOptions.option2.text;
                    document.getElementById('custom-option2-emoji').value = customOptions.option2.emoji;

                    // Update coin display
                    document.getElementById('coin-content').innerHTML = `
                        <div class="text-9xl mb-4 modern-glow">${customOptions.option1.emoji}</div>
                        <div class="text-lg font-semibold" style="color: var(--text-primary);">READY</div>
                    `;
                }
            }
        }

        // Update quote - Christmas version
        function updateQuote() {
            const quote = magicalQuotes[Math.floor(Math.random() * magicalQuotes.length)];
            const parts = quote.split('|');
            document.getElementById('current-quote').textContent = `"${parts[0]}"`;
            document.getElementById('quote-translation').textContent = parts[1];
        }

        // Markov prediction
        function getMarkovPrediction() {
            const probabilities = markovMatrix[markovState];
            const random = Math.random();
            return random < probabilities['H'] ? 'H' : 'T';
        }

        // Flip coin - Christmas version with sound effects
        function flipCoin() {
            if (!isPremium && tosses >= 10) {
                playMagicalChime();
                document.getElementById('subscription-modal').style.display = 'flex';
                return;
            }

            if (isFlipping) return;

            isFlipping = true;
            playJingleSound();

            const coin = document.getElementById('coin');
            const coinContent = document.getElementById('coin-content');
            const flipBtn = document.getElementById('flip-btn');

            coin.classList.add('animate-spin');
            coin.style.transform = 'scale(1.2)';
            flipBtn.innerHTML = '<span class="relative z-10">FLIPPING...</span>';
            flipBtn.disabled = true;

            coinContent.innerHTML = `
                <div class="text-9xl animate-pulse mb-4 modern-glow">üåÄ</div>
                <div class="text-lg font-semibold animate-pulse" style="color: var(--text-primary);">DECIDING...</div>
            `;

            // Create particle effects during spin
            setTimeout(() => {
                const coinRect = coin.getBoundingClientRect();
                const centerX = coinRect.left + coinRect.width / 2;
                const centerY = coinRect.top + coinRect.height / 2;
                createParticleBurst(centerX, centerY);
            }, 1000);

            setTimeout(() => {
                playMagicalChime();

                const result = getMarkovPrediction();
                markovState = result;
                history = [result, ...history.slice(0, 9)];
                tosses++;

                // Record to global stats
                recordGlobalFlip(result);

                // Sync to multiplayer room if active
                if (currentRoom && isHost && db) {
                    db.ref(`rooms/${currentRoom}/lastFlip`).set({
                        result: result,
                        timestamp: Date.now()
                    });
                }

                coin.classList.remove('animate-spin');
                coin.style.transform = 'scale(1)';

                // Heads or Tails result
                const isHeads = result === 'H';

                // Use custom options if enabled
                const displayEmoji = isHeads
                    ? (customOptions.enabled ? customOptions.option1.emoji : 'üéÖ')
                    : (customOptions.enabled ? customOptions.option2.emoji : 'ü¶å');

                const displayText = isHeads
                    ? (customOptions.enabled ? customOptions.option1.text.toUpperCase() + '!' : 'HEADS!')
                    : (customOptions.enabled ? customOptions.option2.text.toUpperCase() + '!' : 'TAILS!');

                coinContent.innerHTML = `
                    <div class="text-9xl mb-3 modern-glow">${displayEmoji}</div>
                    <div class="text-2xl tracking-wider font-bold magical-text" style="color: ${isHeads ? '#FFD700' : '#FF6B6B'};">${displayText}</div>
                `;

                updateStats();
                updateHistory();
                updateQuote();
                checkLimit();

                flipBtn.innerHTML = '<span class="relative z-10">FLIP THE COIN</span>';
                flipBtn.disabled = false;
                isFlipping = false;
            }, 2500);
        }

        // Update stats
        function updateStats() {
            document.getElementById('total-count').textContent = tosses;
            document.getElementById('heads-count').textContent = history.filter(h => h === 'H').length;
            document.getElementById('tails-count').textContent = history.filter(h => h === 'T').length;

            // Update labels if custom options enabled
            if (customOptions.enabled) {
                document.querySelectorAll('#heads-count ~ .text-xs')[0].textContent = customOptions.option1.text.toUpperCase();
                document.querySelectorAll('#tails-count ~ .text-xs')[0].textContent = customOptions.option2.text.toUpperCase();
            }
        }

        // Update history
        function updateHistory() {
            if (history.length > 0) {
                document.getElementById('history-section').style.display = 'block';
                const historyDisplay = document.getElementById('history-display');
                historyDisplay.innerHTML = '';

                history.forEach(flip => {
                    const element = document.createElement('div');
                    const isHeads = flip === 'H';

                    // Use custom emoji if enabled
                    const emoji = isHeads
                        ? (customOptions.enabled ? customOptions.option1.emoji : 'üåü')
                        : (customOptions.enabled ? customOptions.option2.emoji : 'üí´');

                    element.className = `w-12 h-12 rounded-full border-2 flex items-center justify-center text-2xl transition-all hover:scale-110 glass-card`;
                    element.style.background = isHeads ? 'rgba(99, 102, 241, 0.2)' : 'rgba(236, 72, 153, 0.2)';
                    element.style.borderColor = isHeads ? 'var(--primary)' : 'var(--secondary)';
                    element.textContent = emoji;
                    historyDisplay.appendChild(element);
                });
            }
        }

        // Check limit
        function checkLimit() {
            if (!isPremium && tosses >= 8) {
                const remaining = 10 - tosses;
                document.getElementById('remaining-flips').textContent = remaining;
                document.getElementById('limit-warning').style.display = 'block';
            }
        }

        // Buy premium
        function buyPremium() {
            isPremium = true;
            document.getElementById('subscription-modal').style.display = 'none';
            document.getElementById('premium-badge').style.display = 'inline-flex';
            document.getElementById('limit-warning').style.display = 'none';
        }

        // Close modal
        function closeModal() {
            document.getElementById('subscription-modal').style.display = 'none';
        }

        // Reset app
        function resetApp() {
            playJingleSound();
            tosses = 0;
            history = [];
            markovState = 'H';

            document.getElementById('coin-content').innerHTML = `
                <div class="text-9xl mb-4 modern-glow">‚ö°</div>
                <div class="text-lg font-semibold" style="color: var(--text-primary);">READY</div>
            `;

            updateStats();
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('limit-warning').style.display = 'none';
            updateQuote();
        }

        // Add CSS animation for falling
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh);
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize floating particles
        createFloatingParticles();
    </script>
</body>
</html>